<div class="wrapper-friends">
    <!-- <div class="title-container"> -->
        <!-- <div class="title">
            <h1>{{ _("Friends information") }}</h1>
            <p>{{ _("The page for all friend related information:") }}</p>
            <p class="lead">{{ _("Add friends and compare your exploration achievements!") }}</p>
        </div> -->

        <div class="add-friend-container">
            <h2>{{ _("Search friends") }}</h2>
            <!-- <h1>{{ _("Friends information") }}</h1> -->
            <p class="form-info">{{ _("Add friends and compare your exploration achievements!") }}</p>
            <div class="form-wrapper" id="search-users-form">
                <form class="search-users" method="POST" action="{{ url_for('auth.profile') }}">
                    {{ friends_form.hidden_tag() }}
                    <div class="search-text form-control">
                        {{ friends_form.search_text }}
                        {{ friends_form.submit }}
                    </div>
                </form>
            </div>
        {% if users %}
            {% for user in users %}
                {% set ns = namespace(active_friendship=false) %}
                <div class="user-container">
                    <div>
                        <h3>{{ user.username }}</h3>
                        <!-- <p>{{ _("You are already friends.") }}</p> -->

                        {% if current_user.initiated_friendships and ns.active_friendship == false %}
                        {% for initiated_friendship in current_user.initiated_friendships %}
                            {% if initiated_friendship.user_2 == user.id and initiated_friendship.status == 'accepted' %}
                                <p>{{ _("You are already friends.") }}</p>
                                {% set ns.active_friendship = true %}
                            {% elif initiated_friendship.user_2 == user.id %}
                                <p>{{ _("Friend request already sent.") }}</p>
                                {% set ns.active_friendship = true %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
    
                    {% if current_user.received_friendships and ns.active_friendship == false %}
                        {% for received_friendship in current_user.received_friendships %}
                            {% if received_friendship.user_2 == current_user.id and received_friendship.status == 'accepted' %}
                                <p>{{ _("You are already friends.") }}</p>
                                {% set ns.active_friendship = true %}
                            {% elif received_friendship.user_2 == current_user.id %}
                                <p>{{ _("Pending friend request already received.") }}</p>
                                {% set ns.active_friendship = true %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    </div>

                {% if not ns.active_friendship %}
                <form class="request-form" method="POST" action="{{ url_for('auth.send_friend_request', user_id=user.id) }}">
                    <button class="send-request-btn btn" type="submit">{{ _("Send friend request") }}</button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        {% endif %}
        </div>

    <!-- </div> -->

    {% if not (users_requesting == [] and users_awaiting == []) %}
    <div class="friend-requests-container">
        <h3>{{ _("Pending friend requests") }}</h3>

        {% for user in users_requesting %}
        <p>{{ _("Incoming friend request from") }} {{ user.username }}</p>
        <form class="request-accept-form" method="POST"
            action="{{ url_for('auth.accept_friend_request', user_id=user.id) }}">
            <button type="submit">Accept friend request</button>
        </form>
        <form class="request-decline-form" method="POST"
            action="{{ url_for('auth.remove_friend_request', user_id=user.id) }}">
            <button type="submit">Decline friend request</button>
        </form>
        {% endfor %}

        <br>
        {% for user in users_awaiting %}
        <p>{{ _("Pending friend request approval from") }} {{ user.username }}</p>
        <form class="request-accept-form" method="POST"
            action="{{ url_for('auth.remove_friend_request', user_id=user.id) }}">
            <button type="submit">Cancel friend request</button>
        </form>
        {% endfor %}
    </div>
    {% endif %}

    <div class="friends-container">
        <h2>{{ _("Friends list") }}</h2>
        {% if friends == [] %}
        <p>{{ _("Seems like you haven't added any friends yet. Start adding friends to compare your exploration progression and achievements!") }}</p>
        {% else %}
        <div class="friends-grid">
            {% for user in friends %}
            <div class="friend">
                <div class="image-container">
                    <img src="{{ user.gravatar() }}" alt="Gravatar" class="gravatar-img">
                </div>
                <div class="text-container">
                    <h3>{{ user.username }}</h3>
                    <p><span>{{ _("Achievement points") }}: </span>{{ _("WorkInProgress") }}</p>
                </div>
                <form class="remove-friend" method="POST" action="{{ url_for('auth.remove_friend', user_id=user.id) }}">
                <button class="remove-friend-btn" type="submit">{{ _("Remove friend") }}</button>
            </form>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
